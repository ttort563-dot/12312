name: run_bundling
on:
  workflow_dispatch: 

jobs:
  bundle_windows_x86_64:
    runs-on: windows-2022 
    env:
      CARGO_TERM_COLOR: always
      RUST_BACKTRACE: '1'
      CARGO_INCREMENTAL: 0
      ZED_WORKSPACE: ${{ github.workspace }}
    steps:
    - name: checkout_repo
      uses: actions/checkout@v4
      with:
        clean: false

    - name: setup_rust
      uses: dtolnay/rust-toolchain@stable

    - name: Patch Script (Surgical Fix)
      # Мы меняем Community на Enterprise и заменяем только сами вызовы функций 
      # на команду "Write-Host", чтобы не ломать логику скрипта.
      run: |
        (Get-Content script/bundle-windows.ps1) | ForEach-Object {
            $_ -replace 'Community', 'Enterprise' `
               -replace '^\s*CheckEnvironmentVariables\s*$', 'Write-Host "Skipping Env Check"' `
               -replace '^\s*Sign-File\s*.*$', 'Write-Host "Skipping Signing"'
        } | Set-Content script/bundle-windows.ps1
      shell: pwsh

    - name: run_bundling
      # Запускаем сборку. Теперь синтаксис будет правильным.
      run: powershell script/bundle-windows.ps1 -Architecture x86_64
      shell: pwsh

    - name: upload_artifact
      uses: actions/upload-artifact@v4
      with:
        name: Zed-Windows-Bypassed
        # После сборки Zed обычно создает исполняемый файл здесь:
        path: target/release/zed.exe 
        if-no-files-found: warn
